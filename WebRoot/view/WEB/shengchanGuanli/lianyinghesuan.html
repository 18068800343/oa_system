<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="../../font2/iconfont.css">
	<link href="../../style/bootstrap.min.css" rel="stylesheet">
    <link href="../../style/style.css" rel="stylesheet">
    <link rel="stylesheet" href="../../style/jquery.dataTables.min.css">
    <link rel="stylesheet" href="../../style/jquery-editable-select.css">
    <link href="../../toastr/toastr.css" rel="stylesheet">
    <style lang="">
        .UpperPart{
            display: flex;
            justify-content:space-between;
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
        }
        .selected{
            background: rgba(247, 161, 3,0.2);
        }
        #mainContent th{
            cursor: pointer;
        }
    </style>
</head>
<body>
    
    <!-- 面包屑 -->
    <div class="mianbao">
    	<ul class="breadcrumb">
    		<li><i class="iconfont icon-knowledgebase"></i></li>
            <li>生产管理</li>
			<li class="active">联营项目核算</li>
		</ul>
    </div>

    <div class="zhuti-content">
        <div class="UpperPart">
	            <div class="UpperPartL" style="font-size:18px;">
	                <div class="yihang">
	           			<button type="button" class="btn btn-primary Peccxba" style="margin-left: 10px;" data-toggle="modal" data-target="#myModal">填报联营项目核算</button>
				    </div>
	            </div>
	            <div class="UpperPartR">
	                 <div class='yihang'>
                    	<input class="form-control" id="searchData" value="" placeholder="搜索" type="text">
                     </div>
	            </div>
        </div>
        <div class="LowerPart" style="margin-top:3px;">
            <table class="table table-bordered table-condensed" id="mainContent">
                  <thead>
                    <tr>
                    	<th style="width:50px;">序号</th>
                    	<th style="width:300px;">项目名称</th>
                        <th style="width:100px;">合同编号</th>
                        <th style="width:150px;" class="jinqianyanse">合同金额</th>
                        <th style="width:150px;" class="jinqianyanse">结算金额</th>
                        <th style="width:200px;">联营单位</th>
                        <th style="width:100px;">联营合同编号</th>
                        <th style="width:150px;" class="jinqianyanse">项目财务结算</th>
                        <th style="width:150px;" class="jinqianyanse">分包费总额</th>
                        <th style="width:150px;" class="jinqianyanse">管理费</th>
                        <th style="width:80px;">管理费率</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal -->
<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="myModal">
    <div class="modal-dialog modal-lg" role="document" style="width:60%;">
        <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel"><b>填报联营项目核算</b></h4>
        </div>
        <div class="modal-body">
                <div>     
                    <form class="form-inline" method="post" id="new_form" enctype="multipart/form-data">
	                    	<table class="table table-bordered table-condensed">
			                    	<thead>
			                    		<tr>
			                    			<th colspan="4">项目基本信息</th>
			                    		</tr>
			                    	</thead>
			                    	<tbody>
				                    	<tr>
		                            		<td style="width:15%;">项目名称</td>
		                            		<td style="width:35%;">
		                            				<div class="yihang">
		                            					<input type="text"  class="form-control" style="width:70%;" disabled id="prjName">
		                            					<button type="button" class="btn btn-primary" style="margin-left: 6px;" id="chosexm">选择</button>
		                            				</div>
		                            		</td>
		                            		<td style="width:15%;" class="jingyongkk">任务单号</td>
		                            		<td style="width:35%;"><input type="text"  style="width:70%;" class="form-control" id="task_no" disabled></td>
		                            	</tr>
		                            	<tr>
		                            		<td class="jinqianyanse">项目结算金额</td>
		                            		<td><input type="text"  class="form-control" style="width:70%;" disabled id="prj_end_money"></td>
		                            		<td class="jinqianyanse">承接合同金额</td>
		                            		<td><input type="text"  class="form-control" style="width:70%;" disabled id="cjjine"></td>
		                            	</tr>
		                            	<tr>
		                            		<td class="jingyongkk">承接合同编号</td>
		                            		<td><input type="text"  class="form-control" style="width:70%;" disabled id="cjbianhao"></td>
		                            		<td></td>
		                            		<td></td>
		                            	</tr>
			                    	</tbody>
	                    	</table>
	                        <table class="table table-bordered table-condensed">
	                            	<thead>
			                    		<tr>
			                    			<th colspan="4">联营信息</th>
			                    		</tr>
			                    	</thead>
			                    	<tbody>
				                    		<tr>
			                            		<td style="width:15%;" class="jingyongkk">联营单位</td>
			                            		<td style="width:35%;">
			                            				<input type="text"  style="width:70%;" class="form-control" id="lydanwei" disabled>
			                            		</td>
			                            		<td style="width:15%;" class="jingyongkk">联营合同编号</td>
			                            		<td style="width:35%;"><input type="text"  style="width:70%;" class="form-control" id="ly_no" disabled></td>
			                            	</tr>
			                            	<tr>
			                            		<td class="jingyongkk">项目财务结算</td>
			                            		<td>
			                            			<input type="text"  style="width:70%;" class="form-control" id="end_money" disabled>
			                            		</td>
			                            		<td class="jinqianyanse">分包总费用</td>
			                            		<td>
			                            			<input type="text"  style="width:70%;" class="form-control" id="all_fb_money" disabled>
			                            		</td>
			                            	</tr>
			                            	<tr>
			                            		<td class="shuziyanse">管理费率</td>
			                            		<td>
			                            			<input type="text"  style="width:70%;" class="form-control" id="manage_fee" disabled>
			                            		</td>
			                            		<td class="jinqianyanse">管理费</td>
			                            		<td>
			                            			<input type="text"  style="width:70%;" class="form-control" id="manage_money" disabled>
			                            		</td>
			                            	</tr>
			                    	</tbody>
	                        </table>
                    </form>  
                </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal" onclick="clearL()">取消</button>
            <button type="button" class="btn btn-success"  onclick="save()">保存</button>
        </div>
        </div>
    </div>
</div>
<!-- model结束 -->

<!-- Modal选项目 -->
<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="xiangmumd">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel"><b>选择项目</b></h4>
        </div>
        <div class="modal-body">
                <div>     
                    <form class="form-inline">
                        <table class="table table-bordered table-condensed" id="xiangmubiao">
                            <thead>
                            	<tr>
                            		<th></th>
                            		<th>编号</th>
                                    <th>项目名称</th>
                                    <th>项目所属公司</th>
                                    <th>项目类型</th>
                            	</tr>
                            </thead>
                            <tbody>
                                
                            </tbody>
                        </table> 
                    </form>  
                </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-success" id="quedingxm">保存</button>
        </div>
        </div>
    </div>
</div>
<!-- model选项目结束 -->

</body>
<script src="../../js/jquery.js"></script>
<script src="../../js/common-scripts.js"></script>
<script src="../../js/jquery.dataTables.min.js"></script>
<script src="../../js/bootstrap.min.js"></script>
<script src="../../js/quanxian.js"></script>
<script src="../../js/laydate/laydate.js"></script>
<script src="../../js/jquery-editable-select.js"></script>
<script src="../../toastr/toastr.js"></script>
<script src="../../js/jquery-form.min.js"></script>
<script>
    $(document).ready( function () {
    	initTable();
	});
    var table=$('#mainContent').DataTable({
        "deferRender": true,
        "processing": true,
        "bDestroy": true,
        "iDisplayLength": 10,
        "sDom": 
			"t"+
			"<'dt-toolbar-footer'<'col-sm-6 col-xs-12 hidden-xs'i><'col-xs-12 col-sm-6'p>>",
        "searching": true,
        "lengthChange": false,
        "autoWidth": true,
        "sScrollX": true,
        "oLanguage": {
		    "sSearch": '<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>'
		},
		"columns": [
		            { "data": null}, 
		            { "data": null},
		            { "data": null}, 
		            { "data": "contractMoney", render: $.fn.dataTable.render.number( ',', '.', 2, '' )}, 
		            { "data": "prjMoney", render: $.fn.dataTable.render.number( ',', '.', 2, '' )}, 
		            { "data": "lyUnit"}, 
		            { "data": null},
		            { "data": "prjCwEnd"},
		            { "data": "prjAllFb", render: $.fn.dataTable.render.number( ',', '.', 2, '' )},
		            { "data": "managementMoney", render: $.fn.dataTable.render.number( ',', '.', 2, '' )},
		            { "data": "managementFee", render: $.fn.dataTable.render.number( ',', '.', 2, '' )}
		        ],
		        "columnDefs": [
			        	 {	
							 "class": "tcenter",
							  "targets": 1,
							  "searchable": true,
							  "render": function(data, type, full) {
								  return '<a href="../chankanxiangqing/taskDetails.html?prjNo='+data.prjNo+'" style="color:#4876FF;cursor: pointer;" target="_blank" >'+data.prjName+'</a>'
							  }
							},
							{	
								 "class": "tcenter",
								  "targets": 2,
								  "searchable": true,
								  "render": function(data, type, full) {
									  return '<a href="../chankanxiangqing/cjContractDetails.html?cjCNo='+data.contractNo+'" style="color:#4876FF;cursor: pointer;" target="_blank" >'+data.contractNo+'</a>'
								  }
								},
								{	
									 "class": "tcenter",
									  "targets": 6,
									  "searchable": true,
									  "render": function(data, type, full) {
										  return '<a href="../chankanxiangqing/lianyingDetails.html?lyNo='+data.lyNo+'" style="color:#4876FF;cursor: pointer;" target="_blank" >'+data.lyNo+'</a>'
									  }
									}
    				],
		        "fnDrawCallback" : function() {
					$.ajax({
                		type:"post",
                		url:getContextPath()+"/login/getUser",
                		async:false,
                		data:{
                		},
                		success:function(json){
                			
                			if(json!=null &&json!=""){
                				var arr = json.uPermissions.split(',');
                				
                				for(var i=0;i<arr.length;i++){
                					var arr2 = arr[i].replace("+","");
                					if(arr[i].indexOf("Peccxba") >= 0 ){
                						$(".Peccxba").show();
                					}
                				}
                				
                			}
                			
                		}
                	});
					
				},
        "order": [[1, 'asc']],
        "oLanguage": { //国际化配置
        "sProcessing": "正在获取数据，请稍后...",
        "sLengthMenu": "显示 _MENU_ 条",
        "sZeroRecords": "查询不到相关数据",
        "sInfo": "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
        "sInfoEmpty": "记录数为0",
        "sInfoFiltered": "(全部记录数 _MAX_ 条)",
        "sInfoPostFix": "",
        "sSearch": "搜索",
        "sUrl": "",
        "oPaginate": {
            "sFirst": "第一页",
            "sPrevious": "上一页",
            "sNext": "下一页",
            "sLast": "最后一页"
        }},
        "fnDrawCallback"  : function(){
          　　this.api().column(0).nodes().each(function(cell, i) {
          　　　　cell.innerHTML =  i + 1;
         })
        },
	});
    
    var table3=$('#xiangmubiao').dataTable({
        "deferRender": true,
        "processing": true,
        "bDestroy": true,
        "iDisplayLength": 5,
        "searching": true,
        "lengthChange": false,
        "oLanguage": {
		    "sSearch": '<span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>'
		},
		"columns": [
					{ "data": null},
		            { "data": "prjNo"}, 
		            { "data": "prjName"},
		            { "data": "prjCompany"}, 
		            { "data": "prjType2"}, 
		            
		        ],
		        "columnDefs": [
								{	
										 "class": "tcenter",
										    "targets": 0,
										    "searchable": true,
										    "render": function(data, type, full) {
										  	  		return '<input type="radio" name="xiangmuName" style="width:16px;height:16px;">'
										        }
										  }
								],
        "order": [[1, 'asc']],
        "oLanguage": { //国际化配置
        "sProcessing": "正在获取数据，请稍后...",
        "sLengthMenu": "显示 _MENU_ 条",
        "sZeroRecords": "查询不到相关数据",
        "sInfo": "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
        "sInfoEmpty": "记录数为0",
        "sInfoFiltered": "(全部记录数 _MAX_ 条)",
        "sInfoPostFix": "",
        "sSearch": "搜索",
        "sUrl": "",
        "oPaginate": {
            "sFirst": "第一页",
            "sPrevious": "上一页",
            "sNext": "下一页",
            "sLast": "最后一页"
        }},
        
	});
    
    
    function initTable(){
        $.ajax({
            type: 'POST',
            url: getContextPath()+'/LianYing/selectLianYingHeSuan',
            dataType: 'json',
            data: {
            },
            success: function (json) {
            	console.log(json)
                $('#mainContent').dataTable().fnClearTable();
                $('#mainContent').DataTable().rows.add(json).draw(false);
            }
        });
    }
    
  //选择项目
	$("#chosexm").click(function(){
		$("#xiangmumd").modal("show");
		$('#xiangmumd').on('hidden.bs.modal', function () {//解决模态框页面滚动问题
            if ($('.modal.in').size() >= 1) {
                $('body').addClass('modal-open')
            }
        })
		 $.ajax({
	            type: 'POST',
	            url: getContextPath()+'/task/selectPrjNameAndWorkNo',
	            dataType: 'json',
	            async:false,
	            data: {
	            },
	            success: function (json) {
	                $('#xiangmubiao').dataTable().fnClearTable();
	                $('#xiangmubiao').DataTable().rows.add(json).draw(false);
	            }
	        });
	})
	
	$("#quedingxm").click(function(){
		var tr=$("input[name='xiangmuName']:checked").parents("tr");
		var data=$("#xiangmubiao").DataTable().row(tr).data();
		$("#prjName").val(data.prjName);
		$("#prjName").attr("data1",data.prjId);
		$("#task_no").val(data.prjNo);
		$("#xmleixing").val(data.prjType2);
		$("#yzdanwei").val(data.ccName);
		$("#diqu").val(data.prjArea);
		$("#prj_end_money").val(data.prjEstimateMoney);
		
		$.ajax({
            type: 'POST',
            url: getContextPath()+'/cj/selectCjContractLikeTaskCode',
            dataType: 'json',
            async:false,
            data: {
            	no:data.prjNo
            },
            success: function (json) {
            	$("#cjbianhao").val(json.contractNo);
        		$("#cjdanwei").val(json.ccName);
        		$("#cjjine").val(json.contractMoney);
            }
        });
		$.ajax({
            type: 'POST',
            url: getContextPath()+'/LianYing/selectLianYingByNo',
            dataType: 'json',
            async:false,
            data: {
            	no:data.prjNo
            },
            success: function (json) {
            	var ly=json.ly;
            	var allCost=json.allCost;
            	var fbEndMoney=json.fbEndMoney;
            	$("#lydanwei").val(ly.lyUnitName);
            	$("#ly_no").val(ly.lyNo);
            	$("#end_money").val(allCost)
            	$("#all_fb_money").val(fbEndMoney);
            	var manageMoney=data.prjEstimateMoney-allCost-fbEndMoney;
            	$("#manage_money").val(manageMoney)
            	var manageFee=(manageMoney/data.prjEstimateMoney*100).toFixed(2)+"%";
            	$("#manage_fee").val(manageFee);
            }
        });
		$("#xiangmumd").modal("hide");
	})
	
	function clearL(){
		  $("#myModal input").val("");
   }
	
	function save(){
	  var prjName=$("#prjName").val();
	  var prjNo=$("#task_no").val();
	  var prjMoney=$("#prj_end_money").val();
	  var contractMoney=$("#cjjine").val();
	  var contractNo=$("#cjbianhao").val();
	  var lyUnit=$("#lydanwei").val();
	  var lyNo=$("#ly_no").val();
	  var prjCwEnd=$("#end_money").val();
	  var prjAllFb=$("#all_fb_money").val();
	  var managementFee=$("#manage_fee").val();
	  var managementMoney=$("#manage_money").val();
	  
	  $.ajax({
          type: 'POST',
          url: getContextPath()+'/LianYing/addLianYingHeSuan',
          dataType: 'json',
          data: {
        	  prjName:prjName,
        	  prjNo:prjNo,
        	  prjMoney:prjMoney,
        	  contractNo:contractNo,
        	  contractMoney:contractMoney,
        	  lyUnit:lyUnit,
        	  lyNo:lyNo,
        	  prjCwEnd:prjCwEnd,
        	  prjAllFb:prjAllFb,
        	  managementFee:managementFee,
        	  managementMoney:managementMoney
          },
          success: function (json) {
          	if(json.result>0){
          		 clearL();
          		 toastr.success('保存成功');
          		 var  hs=json.hs;
          		 $("#myModal").modal("hide");
          		 $('#mainContent').DataTable().row.add(hs).draw(false);
          	}else{
          		toastr.error('保存失败');
          	}
          }
      });
  	}
	$("#searchData").on("input", function(e){
		var d = $("#searchData").val();
		$("#mainContent").DataTable().search(d).draw(true);
	});
</script>
</html>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.ldxx.dao.LianYingDao" >
	<resultMap type="org.ldxx.bean.LianYing" id="LianYingResultMap">
		<id property="lyId"  column="ly_id" />
		<result property="lyId"  column="ly_id" />
		<result property="lyNo"  column="ly_no" />
		<result property="prjNo"  column="prj_no" />
		<result property="prjName"  column="prj_name" />
		<result property="prjArea"  column="prj_area" />
		<result property="prjType2"  column="prj_type2" />
		<result property="ccName"  column="cc_name" />
		<result property="contractMoney"  column="contract_money" />
		<result property="contractNo"  column="contract_no" />
		<result property="contractNameYi"  column="contract_name_yi" />
		<result property="lyUnit"  column="ly_unit" />
		<result property="lyUnitName"  column="lyUnitName" />
		<result property="uniformCode"  column="uniform_code" />
		<result property="certifications"  column="certifications" />
		<result property="safetyCertificateInfo"  column="safety_certificate_info" />
		<result property="openingAccounts"  column="opening_accounts" />
		<result property="openingBank"  column="opening_bank" />
		<result property="fb_info"  column="fbInfo" />
		<result property="contractType"  column="contract_type" />
		<result property="managementFee"  column="management_fee" />
		<result property="otherFee"  column="other_fee" />
		<result property="fbMoney"  column="fb_money" />
		<result property="payTime"  column="pay_time" />
		<result property="pbType"  column="pb_type" />
		<result property="pbMoney"  column="pb_money" />
		<collection property="fb" column="prj_no" ofType="FbContract" select="selectFbContractByNo">
 	       <id property="fbId" column="fb_id" />
 	       <result property="fbNo" column="fb_no" />
 	       <result property="contractName" column="contract_name" />
 	       <result property="fbcType" column="fbc_type" />
 	       <result property="ccName" column="cc_name" />
 	       <result property="contractMoney" column="contract_money" />
 	    </collection>
	</resultMap>


	<insert id="addLianYing" parameterType="LianYing">
		insert into lian_ying_contract(ly_id,ly_no,prj_no,ly_unit,uniform_code,certifications,
					safety_certificate_info,opening_accounts,opening_bank,fb_info,contract_type,
					management_fee,other_fee,fb_money,pay_time,pb_type,pb_money)
		values(#{ly.lyId},#{ly.lyNo},#{ly.prjNo},#{ly.lyUnit},#{ly.uniformCode},#{ly.certifications},
				   #{ly.safetyCertificateInfo},#{ly.openingAccounts},#{ly.openingBank},#{ly.fbInfo},#{ly.contractType},
				   #{ly.managementFee},#{ly.otherFee},#{ly.fbMoney},#{ly.payTime},#{ly.pbType},#{ly.pbMoney})
	</insert>
	
	<select id="selectLianYingByStatus"  resultMap="LianYingResultMap">
		SELECT a.*,c.prj_name,c.prj_area,c.prj_type2,d.cc_name,e.contract_money,e.contract_no,contract_name_yi,d2.cc_name as lyUnitName 
		FROM lian_ying_contract as a
		LEFT JOIN mode_status as b on a.ly_id=b.mode_id
		LEFT JOIN task as c on a.prj_no=c.prj_no
		LEFT JOIN consociation_company as d on c.prj_owner_unit=d.cc_id
		LEFT JOIN consociation_company as d2 on a.ly_unit=d2.cc_id
		LEFT JOIN cj_contract as e on a.prj_no like concat('%',e.task_code,'%') 
		where b.status=#{status} and c.history=1 and e.history=1
	</select>
	
	<select id="selectFbContractByNo" resultType="FbContract">
		SELECT a.*,b.cc_name FROM fb_contract as a 
		LEFT JOIN consociation_company as b on a.contract_name_yi=b.cc_id
		where a.work_no=#{prj_no} and a.history=1
	</select>
	
	<select id="selectLianYingById" resultType="LianYing">
		SELECT a.*,c.prj_name,c.prj_area,c.prj_type2,d.cc_name,e.contract_money,contract_name_yi,d2.cc_name as lyUnitName
		FROM lian_ying_contract as a
		LEFT JOIN mode_status as b on a.ly_id=b.mode_id
		LEFT JOIN task as c on a.prj_no=c.prj_no
		LEFT JOIN consociation_company as d on c.prj_owner_unit=d.cc_id
		LEFT JOIN consociation_company as d2 on a.ly_unit=d2.cc_id
		LEFT JOIN cj_contract as e on a.prj_no like e.task_code
		where a.ly_id=#{id} and c.history=1 and e.history=1
	</select>
	
	<select id="lyNoCount" resultType="int">
		SELECT COUNT(1) FROM(
			SELECT DISTINCT ly_no FROM lian_ying_contract where ly_no like #{year}) as a
	</select>
</mapper>
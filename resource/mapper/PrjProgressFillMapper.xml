<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.ldxx.dao.PrjProgressFillDao" >
  	<insert id="addPrjProgressFill" parameterType="PrjProgressFill">
  		insert into prj_progress_fill(ppf_id,prj_name,task_no,prj_type,contract_money,prj_leader,
  									provisional_sum,prj_start_time,prj_end_time,
  									this_time,all_money,all_cost,prj_this_income,status)
  		values(#{ppf.ppfId},#{ppf.prjName},#{ppf.taskNo},#{ppf.prjType},#{ppf.contractMoney},#{ppf.prjLeader},
  					#{ppf.provisionalSum},#{ppf.prjStartTime},#{ppf.prjEndTime},
  					#{ppf.thisTime},#{ppf.allMoney},#{ppf.allCost},#{ppf.prjThisIncome},#{ppf.status})
  	</insert>
  	
  	<insert id="addPrjProgressFillInfo" parameterType="java.util.List">
  		insert into prj_progress_fill_info(ppf_id,department,money,type,main)
  		values
  		<foreach collection="ppfi" index="index" item="p" separator=",">
  			(#{p.ppfId},#{p.department},#{p.money},#{p.type},#{p.main})
  		</foreach>
  	</insert>
  	
  	<select id="selectPrjProgressFill"  resultType="PrjProgressFill">
  		select a.* from prj_progress_fill as a left join mode_status as b on a.ppf_id=b.mode_id
  		where b.status=#{status}
  	</select>
  	
  	<select id="selectPrjProgressFillInfo" resultType="PrjProgressFillInfo">
  		select * from prj_progress_fill_info where ppf_id=#{id} and type=#{type}
  	</select>
  	
  	<select id="selectPrjProgressFillById" resultType="PrjProgressFill">
  		select * from prj_progress_fill where ppf_id=#{id}
  	</select>
  	
  	<select id="selectLastPrjProgressFill" resultType="PrjProgressFill">
  		select ppf_id,all_money from prj_progress_fill where task_no=#{no} ORDER BY this_time desc LIMIT 1
  	</select>
  	
  	<select id="getLastByDepartmentAndId" resultType="PrjProgressFillInfo">
  		select money from prj_progress_fill_info where ppf_id=#{id} and department=#{department} and type='1'
  	</select>
  	
  	<insert id="addPrjProgressFillCj" parameterType="java.util.List">
  		insert into prj_progress_fill_cj(ppf_id,cj_id,cj_name,contract_money,temporary_money,income_bq,income_all) 
  		values
  		<foreach collection="ppcj" index="index" item="p" separator=",">
  			(#{p.ppfId},#{p.cjId},#{p.cjName},#{p.contractMoney},#{p.temporaryMoney},#{p.incomeBq},#{p.incomeAll})
  		</foreach>
  	</insert>
  	
  	<select id="cjBq"  resultType="PrjProgressFillCj">
  		select income_all from prj_progress_fill_cj where ppf_id=#{ppfId} and cj_id=#{cjId}
  	</select>
  	
  	<select id="selectPrjProgressFillCjById" resultType="PrjProgressFillCj">
  		select * from prj_progress_fill_cj where ppf_id=#{id}
  	</select>
  	
  	<select id="selectPrjProgressFillByStatus" resultType="PrjProgressFill">
  		select a.* from prj_progress_fill as a left join mode_status as b on a.ppf_id=b.mode_id
  		where b.status=2 and  a.status=#{status}
  	</select>
  	
  	<update id="updateStatusAndDesc">
  		update prj_progress_fill set status=#{status},infos=#{infos} where ppf_id=#{id}
  	</update>
  	
  	<select id="selectDistinctTaskNo" resultType="PrjProgressFill">
  		SELECT DISTINCT task_no from  prj_progress_fill where this_time like #{year}
  	</select>
  	
  	<select id="getCost" resultType="PrjProgressFill">
  		select IFNULL(a.all_cost,0) as all_cost,a.ppf_id from prj_progress_fill as a LEFT JOIN mode_status as b on a.ppf_id=b.mode_id 
  		where b.status=2 and a.task_no=#{no} ORDER BY a.this_time desc limit 1
  	</select>
  	
  	<select id="getDepartmentCost" resultType="float">
  		SELECT IFNULL(money,0) as money FROM prj_progress_fill_info where type=6 and department=#{department} and ppf_id=#{id}
  	</select>
  	
  	<select id="countOfDepartmentCost" resultType="int">
  		SELECT count(1)  FROM prj_progress_fill_info where type=6 and department=#{department} and ppf_id=#{id}
  	</select>
  	
  	<select id="selectPrjProgressFillByYear" resultType="PrjProgressFill">
  		select * from prj_progress_fill as a 
  		left join mode_status as b on a.ppf_id=b.mode_id
  		where b.status=#{status} and this_time like #{y}
  	</select>
  	
  	<select id="selectAllCostAndJd" resultType="PrjProgressFill">
  		SELECT all_money,all_cost FROM prj_progress_fill where task_no=#{no} ORDER BY this_time desc limit 1
  	</select>
  	
  	<select id="selectDepartmentIncome" resultType="PrjProgressFill">
  		SELECT a.all_income,c.money as all_money FROM prj_progress_fill as a LEFT JOIN mode_status as b on a.ppf_id=b.mode_id
		LEFT JOIN prj_progress_fill_info as c on a.ppf_id=c.ppf_id
		where b.status=2 and c.department=#{department} and c.type=2 and this_time BETWEEN #{start} and #{end}
  	</select>
  	
  	<select id="selectYearCostByDepartment" resultType="PrjProgressFillInfo">
  		SELECT SUM(money) as money FROM prj_progress_fill as a
		LEFT JOIN mode_status as b on a.ppf_id=b.mode_id
		LEFT JOIN prj_progress_fill_info as c on a.ppf_id=c.ppf_id
		where a.this_time like #{year} and c.type=5 and department=#{department}
  	</select>
</mapper>